variables:
  REPOSITORY: "cloudcare-forethought/cloudcare-forethought-setup"
  PROJECT: launcher

stages:
  - build

buildProd:
  stage: build
  only:
    - /^release[\/-_]?.*$/
    - /^pre[\/-_]?.*$/
  script:
    - docker buildx build --platform linux/arm64,linux/amd64 -t registry.jiagouyun.com/$REPOSITORY:$CI_COMMIT_REF_NAME . --push
  tags:
    - cloudcare-multiarch 

buildTesting:
  stage: build
  only:
    - dev
  script:
    - CHART_PATH=`find . -maxdepth 3 -name Chart.yaml`
    - TEMP=${CHART_PATH%/*}
    - docker buildx build --platform linux/arm64,linux/amd64 -t pubrepo.jiagouyun.com/$REPOSITORY:testing . --push
    - cp ${CHART_PATH%/*/*}/values.yaml ${CHART_PATH%/*}/values.yaml
    - sed -i "s,{{repository}},registry.jiagouyun.com/$REPOSITORY,g" ${CHART_PATH%/*}/values.yaml
    - sed -i "s,{{tag}},testing,g" ${CHART_PATH%/*}/values.yaml
    - helm package ${CHART_PATH%/*} --version $1.0 --app-version $1.0
    - TEMP=${CHART_PATH%/*}
    - helm cm-push ${TEMP##*/}-1.0.tgz launcher    

  tags:
    - cloudcare-multiarch 

buildRTM:
  stage: build
  only:
    - /\d+\.\d+\.\d+-\w+-\d+-prod/
  script:
    - V=(${CI_COMMIT_REF_NAME//[\.-]/ })
    - VDIR=${V[0]}.${V[1]}.${V[2]}
    - REPO=dataflux/$VDIR
    - TAG=${PROJECT}-${V[3]}-${V[4]}


    - docker buildx build --platform linux/arm64,linux/amd64 -t pubrepo.jiagouyun.com/$REPO:$TAG . --push
  tags:
    - cloudcare-multiarch 

buildRTMPrev:
  stage: build
  only:
    - /\d+\.\d+\.\d+\.\d+-\w+-prev/
  script:
    - V=(${CI_COMMIT_REF_NAME//[\.-]/ })
    - VDIR=${V[0]}.${V[1]}.${V[2]}.${V[3]}
    - REPO=dataflux-prev/$VDIR
    - TAG=${PROJECT}-${V[4]}

    - docker buildx build --platform linux/arm64,linux/amd64 -t pubrepo.jiagouyun.com/$REPO:$TAG . --push
 
  tags:
    - cloudcare-multiarch 

buildTest:
  stage: build
  only:
    - helm
  script:
    - CHART_PATH=`find . -maxdepth 3 -name Chart.yaml`
    - TEMP=${CHART_PATH%/*}
    #- docker buildx build --platform linux/arm64,linux/amd64 -t pubrepo.jiagouyun.com/$REPOSITORY:testing . --push
    - cp ${CHART_PATH%/*/*}/values.yaml ${CHART_PATH%/*}/values.yaml
    - sed -i "s,{{repository}},registry.jiagouyun.com/$REPOSITORY,g" ${CHART_PATH%/*}/values.yaml
    - sed -i "s,{{tag}},testing,g" ${CHART_PATH%/*}/values.yaml
    - helm package ${CHART_PATH%/*} --version 1.0 --app-version 1.0
    - helm cm-push ${TEMP##*/}-1.0.tgz launcher   
  tags:
    - cloudcare-multiarch      
