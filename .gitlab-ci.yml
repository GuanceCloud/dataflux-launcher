variables:
  REPOSITORY: "cloudcare-forethought/cloudcare-forethought-setup"
  PROJECT: launcher

stages:
  - build

buildProd:
  stage: build
  only:
    - /^release[\/-_]?.*$/
    - /^pre[\/-_]?.*$/
  script:
    - docker buildx build --platform linux/arm64,linux/amd64 -t registry.jiagouyun.com/$REPOSITORY:$CI_COMMIT_REF_NAME . --push
  tags:
    - cloudcare-multiarch 

buildTesting:
  stage: build
  only:
    - dev
  script:
    - docker buildx build --platform linux/arm64,linux/amd64 -t registry.jiagouyun.com/$REPOSITORY:testing . --push
  tags:
    - cloudcare-multiarch 

buildRTM:
  stage: build
  only:
    - /\d+\.\d+\.\d+-\w+-\d+-prod/
  script:
    - V=(${CI_COMMIT_REF_NAME//[\.-]/ })
    - VDIR=${V[0]}.${V[1]}.${V[2]}
    - REPO=dataflux/$VDIR
    - TAG=${PROJECT}-${V[3]}-${V[4]}

    - docker buildx build --platform linux/arm64,linux/amd64 -t pubrepo.jiagouyun.com/$REPO:$TAG . --push
  tags:
    - cloudcare-multiarch 

buildRTMPrev:
  stage: build
  only:
    - /\d+\.\d+\.\d+\.\d+-\w+-prev/
  script:
    - V=(${CI_COMMIT_REF_NAME//[\.-]/ })
    - VDIR=${V[0]}.${V[1]}.${V[2]}.${V[3]}
    - REPO=dataflux-prev/$VDIR
    - TAG=${PROJECT}-${V[4]}

    - docker buildx build --platform linux/arm64,linux/amd64 -t pubrepo.jiagouyun.com/$REPO:$TAG . --push
  tags:
    - cloudcare-multiarch 

buildhelm:
  stage: build
  only:
    - helm
  script:
    - V=(${CI_COMMIT_REF_NAME//[\.-]/ })
    - VDIR=${V[0]}.${V[1]}.${V[2]}
    - REPO=dataflux/$VDIR
    - TAG=${PROJECT}-${V[3]}-${V[4]}
    -  cd /root/.local/share/helm/plugins; rm -rf  plugin.yaml LICENSE bin;mkdir helm-push;tar -xvf helm-push_0.10.2_linux_amd64.tar.gz -C helm-push; helm plugin list
; rm -f helm-push_0.10.2_linux_amd64.tar.gz
    #- docker buildx build --platform linux/arm64,linux/amd64 -t pubrepo.jiagouyun.com/$REPO:$TAG . --push
  tags:
    - cloudcare-multiarch     