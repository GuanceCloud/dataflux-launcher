variables:
  REPOSITORY: "cloudcare-forethought/cloudcare-forethought-setup"
  PROJECT: launcher

stages:
  - build

buildProd:
  stage: build
  only:
    - /^release[\/-_]?.*$/
    - /^pre[\/-_]?.*$/
  script:
    - docker build -t $REPOSITORY:$CI_COMMIT_REF_NAME .
    - docker tag $REPOSITORY:$CI_COMMIT_REF_NAME registry.jiagouyun.com/$REPOSITORY:$CI_COMMIT_REF_NAME
    - docker tag $REPOSITORY:$CI_COMMIT_REF_NAME registry.jiagouyun.com/$REPOSITORY:prod
    - docker push registry.jiagouyun.com/$REPOSITORY:$CI_COMMIT_REF_NAME
    - docker push registry.jiagouyun.com/$REPOSITORY:prod
  tags:
    - cloudcare

buildTesting:
  stage: build
  only:
    - dev
  script:
    - docker build -t $REPOSITORY:testing .
    - docker tag $REPOSITORY:testing registry.jiagouyun.com/$REPOSITORY:testing
    - docker push registry.jiagouyun.com/$REPOSITORY:testing
  tags:
    - cloudcare

buildRTM:
  stage: build
  only:
    - /^\d+\.\d+\.\d+-\w+-\d+-prod$/
  script:
    - V=(${CI_COMMIT_REF_NAME//[\.-]/ })
    - VDIR=${V[0]}.${V[1]}.${V[2]}
    - REPO=dataflux/$VDIR
    - TAG=${PROJECT}-${V[3]}-${V[4]}
    - docker build -t $REPO:$TAG .
    - docker tag $REPO:$TAG pubrepo.jiagouyun.com/$REPO:$TAG
    - docker push pubrepo.jiagouyun.com/$REPO:$TAG
  tags:
    - cloudcare