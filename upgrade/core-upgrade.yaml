upgrade:
  - seq: 1
    database: |-
      -- cq 2020/0212
      CREATE TABLE `main_influx_cq` (
        `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '自增 ID',
        `uuid` varchar(48) NOT NULL DEFAULT '' COMMENT '全局唯一 ID 前缀 ifcq-',
        `influxUUID` varchar(48) NOT NULL DEFAULT '',
        `cqName` varchar(128) NOT NULL DEFAULT 'cq_' COMMENT 'CQ name',
        `namePrefix` varchar(48) NOT NULL DEFAULT '',
        `sampleEvery` varchar(48) NOT NULL DEFAULT '30m' COMMENT 'RESAMPLE every XXX',
        `sampleFor` varchar(48) NOT NULL DEFAULT '1h' COMMENT 'RESAMPLE for XXX',
        `db` varchar(48) NOT NULL DEFAULT '' COMMENT '原始 Measurement 所在 DB 名称',
        `rp` varchar(48) NOT NULL DEFAULT '' COMMENT '不填则只用 @db 的默认 RP',
        `cqrp` varchar(48) NOT NULL DEFAULT '' COMMENT '不填则用 CQ 默认的 RP, 比如 rpcq',
        `measurement` varchar(48) NOT NULL DEFAULT '' COMMENT '指标名',
        `cqMeasName` varchar(128) NOT NULL DEFAULT '' COMMENT 'cq 后的指标名，，不指定则  @name',
        `keepTags` tinyint(1) NOT NULL DEFAULT '1' COMMENT '是否在 CQ 的 measurement 上保 原始 tag， 然原始 tag 会被转换成 field',
        `groupByTime` varchar(48) NOT NULL DEFAULT '30m',
        `groupByOffset` varchar(48) NOT NULL DEFAULT '15m',
        `funcFields` json NOT NULL COMMENT '["""mean("field-1") AS "field-1-mean"""",...]',
        `status` int(11) NOT NULL DEFAULT '0',
        `creator` varchar(64) NOT NULL DEFAULT '' COMMENT '创建者 account-id',
        `updator` varchar(64) NOT NULL DEFAULT '' COMMENT '更新者 account-id',
        `createAt` int(11) NOT NULL DEFAULT '-1',
        `deleteAt` int(11) NOT NULL DEFAULT '-1',
        `updateAt` int(11) NOT NULL DEFAULT '-1',
        PRIMARY KEY (`id`),
        UNIQUE KEY `uk_uuid` (`uuid`) COMMENT 'UUID 做成全局唯一'
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

      -- 2/18
      ALTER TABLE main_influx_db ADD COLUMN cqrp VARCHAR(48) NOT NULL AFTER influxRpName;
      UPDATE main_influx_db set cqrp='autogen';

      ALTER TABLE main_kapa DROP FOREIGN KEY kapa_is_uuid;

      -- 场景新增 指标集数据集过滤条件
      ALTER TABLE `biz_scene` 
      ADD COLUMN `measurementLimit` json NOT NULL COMMENT '指标集限制' AFTER `describe`,
      ADD COLUMN `filter` json NOT NULL COMMENT '过滤条件' AFTER `measurementLimit`;

      -- 设置场景历史数据中的 数据范围
      UPDATE biz_scene set filter='[]', measurementLimit='[]' where status=0;

      -- 节点新增 icon 地址配置
      ALTER TABLE `biz_node` 
      ADD COLUMN `iconSet` json NULL COMMENT '图标设置' AFTER `name`;

      -- 同时初始化历史数据
      UPDATE biz_node set iconSet='{}';

      -- 修复生产环境中 已删除场景的分享设置
      UPDATE biz_share_config set status=3 WHERE status=0 and resourceUUID in (select DISTINCT(uuid) from biz_scene WHERE status=3);

  - seq: 2
    database: |-
      -- 管理员添加权限
      ALTER TABLE main_manage_account ADD COLUMN role VARCHAR(10) NOT NULL COMMENT "角色  admin: 管理员/ dev: 开发者" AFTER name;
      -- 数据处理
      update main_manage_account set role="admin" where role = "";

  - seq: 3
    database: |-
      -- 新增 视图变量排序字段
      ALTER TABLE `biz_variable` ADD COLUMN `valueSort` varchar(8) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT '' COMMENT '视图变量的值排序' AFTER `definition`;

      -- 修复创建工作空间未指定成员时默认添加了 空字符串UUID的成员导致的垃圾数据, 修复方式：直接设置删除状态
      UPDATE main_account_workspace set `status`=3 WHERE (accountUUID="" or (accountUUID not REGEXP 'acnt[-_]')) and `status`!= 3;
      UPDATE main_account_privilege set `status`=3 WHERE (accountUUID="" or (accountUUID not REGEXP 'acnt[-_]')) and `status`!= 3;

      -- query 增加枚举类型
      ALTER TABLE `biz_query` MODIFY COLUMN `qtype` enum('HTTP','TSQL','SQL','CUSTOM_FUNC') CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL COMMENT '查询类型' AFTER `query`;

  - seq: 4
    database: |-
      -- 增加内置 DataWay
      INSERT INTO `main_agent` (`uuid`, `name`, `version`, `host`, `port`, `domainName`, `workspaceUUID`, `status`, `creator`, `updator`, `createAt`, `uploadAt`, `deleteAt`, `updateAt`)
      VALUES ('agnt_internal_dataway_1', '内置 DataWay', '0.1-349-gfff24b0', '', 0, '', 'wksp_system', 0, '', '', UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), -1, UNIX_TIMESTAMP());

  # 3.16 迭代
  - seq: 5
    database: |-
      -- 节点新增 是否打开继承开关字段，默认打开
      ALTER TABLE `biz_node` ADD COLUMN `isInheritance` tinyint(1) NOT NULL DEFAULT 1 COMMENT '是否继承' AFTER `filter`;

      -- 节点上新增2个字段，用来控制子节点的图标和继承信息
      ALTER TABLE `biz_node`
      ADD COLUMN `subIconSet` json NULL COMMENT '子节点的图标信息' AFTER `exclude`,
      ADD COLUMN `subIsInheritance` tinyint(1) NOT NULL DEFAULT 1 COMMENT '子节点是否继承父节点过滤条件' AFTER `subIconSet`;

      --  新增ck 黑名单表  03/16/2020
      CREATE TABLE `main_ck_blacklist` (
        `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '自增 ID',
        `uuid` varchar(48) NOT NULL DEFAULT '' COMMENT '全局唯一 ID 前缀 ckbl-',
        `dbUUID` varchar(48) NOT NULL DEFAULT '' COMMENT '原始 Measurement 所在 DB uuid',
        `measurement` varchar(48) NOT NULL DEFAULT '' COMMENT '指标名',
        `status` int(11) NOT NULL DEFAULT '0',
        `creator` varchar(64) NOT NULL DEFAULT '' COMMENT '创建者 account-id',
        `updator` varchar(64) NOT NULL DEFAULT '' COMMENT '更新者 account-id',
        `createAt` int(11) NOT NULL DEFAULT '-1',
        `deleteAt` int(11) NOT NULL DEFAULT '-1',
        `updateAt` int(11) NOT NULL DEFAULT '-1',
        PRIMARY KEY (`id`),
        UNIQUE KEY `uk_uuid` (`uuid`) COMMENT 'UUID 做成全局唯一'
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
    config:
      core: |-
        kodo:
          # 在原有的 命令中追加了 DW_VERSION
          upgradeCmd: 'DW_KODO=http://172.16.0.12:10556  DW_TOKEN={token}  DW_UUID={agent_uuid} DW_AK={ak}  DW_SK={sk} DW_VERSION={version} DW_UPGRADE=1  bash -c "$(curl http://cloudcare-kodo.oss-cn-hangzhou.aliyuncs.com/dataway/test/install.sh)"'

        clickhouse:
          # 新增 clickhouse 启用开关配置项，默认值 false，可以不配置
          open: false
  # 3.31 迭代
  - seq: 6
    database: |-
      # 新增 最大时间线设置
      ALTER TABLE `main_workspace` ADD COLUMN `maxTsCount` int(0) NOT NULL DEFAULT 100 COMMENT '最大时间线' AFTER `dataRestriction`;


      # 衍生节点缓存表
      CREATE TABLE `biz_decorate_node` (
        `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '自增 ID',
        `uuid` varchar(48) NOT NULL COMMENT '全局唯一 ID，带 node- 前缀',
        `workspaceUUID` varchar(48) NOT NULL DEFAULT '' COMMENT '工作空间UUID',
        `sceneUUID` varchar(48) NOT NULL COMMENT '场景 uuid',
        `parentUUID` varchar(48) NOT NULL DEFAULT '' COMMENT '父节点 uuid',
        `name` varchar(128) NOT NULL COMMENT '子节点名称',
        `status` int(11) NOT NULL DEFAULT '0' COMMENT '状态 0: ok/1: 故障/2: 停用/3: 删除',
        `creator` varchar(64) NOT NULL DEFAULT '' COMMENT '创建者 account-id',
        `updator` varchar(64) NOT NULL DEFAULT '' COMMENT '更新者 account-id',
        `createAt` int(11) NOT NULL DEFAULT '-1',
        `deleteAt` int(11) NOT NULL DEFAULT '-1',
        `updateAt` int(11) NOT NULL DEFAULT '-1',
        PRIMARY KEY (`id`),
        UNIQUE KEY `uk_uuid` (`uuid`) COMMENT 'UUID 做成全局唯一',
        KEY `k_ws_uuid` (`workspaceUUID`),
        KEY `scene_node_fk` (`sceneUUID`),
        KEY `node_parent_uuid_fk` (`parentUUID`)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

      # 新增工作空间License表
      CREATE TABLE `main_workspace_license` (
        `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '自增 ID',
        `uuid` varchar(48) NOT NULL DEFAULT '' COMMENT 'license lcn-',
        `workspaceUUID` varchar(64) NOT NULL DEFAULT '' COMMENT '工作空间 uuid',
        `instanceId` varchar(64) NOT NULL DEFAULT '' COMMENT 'LicenseId',
        `extend` json NOT NULL COMMENT '额外拓展字段',
        `creator` varchar(64) NOT NULL DEFAULT '' COMMENT '创建者 account-id',
        `updator` varchar(64) NOT NULL DEFAULT '' COMMENT '更新者 account-id',
        `status` int(11) NOT NULL DEFAULT '0' COMMENT '状态 0: 正常/2: 禁用/3: 删除',
        `createAt` int(11) NOT NULL DEFAULT '-1' COMMENT '创建时间',
        `updateAt` int(11) NOT NULL DEFAULT '-1' COMMENT '更新时间 ',
        `deleteAt` int(11) NOT NULL DEFAULT '-1' COMMENT '删除时间',
        PRIMARY KEY (`id`) COMMENT '主键',
        UNIQUE KEY `uk_instanceId` (`instanceId`) COMMENT 'license id 做成全局唯一'
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

      # 新增 加载标记
      ALTER TABLE `biz_node` ADD COLUMN `isLoading` tinyint(1) NULL AFTER `status`;

  # 4.09 迭代
  - seq: 7
    database: |-
      -- 触发规则 表新增 crontab
      ALTER TABLE `biz_rule`
      ADD COLUMN `crontabInfo` json NULL COMMENT 'crontab配置信息' AFTER `tickInfo`;

      ALTER TABLE `main_workspace_license` ADD COLUMN `version` varchar(48) NOT NULL  COMMENT 'license 版本' AFTER `instanceId`;
      ALTER TABLE `main_workspace_license` ADD COLUMN `expire` int(11) NOT NULL  COMMENT 'license 过期时间' AFTER `instanceId`;
      ALTER TABLE `main_workspace` ADD COLUMN `versionInfo` json  COMMENT '版本信息' AFTER `desc`;

      -- 新增 是否自动聚合
      ALTER TABLE `main_workspace` ADD COLUMN `autoAggregation` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否自动聚合' AFTER `status`;

      -- 新增 告警历史保留时长
      ALTER TABLE `main_workspace` ADD COLUMN `alarmHistoryPeriod` varchar(48) NOT NULL DEFAULT '' COMMENT '告警历史保留时长' AFTER `status`;

      ALTER TABLE `main_workspace` CHANGE `dataRestriction` `dataRestriction` JSON  NULL  COMMENT '数据权限';

      -- 特别说明: 此为 PAAS 版必须执行的，用来更新工作空间中的 时间线和RP等信息
      update main_workspace set alarmHistoryPeriod="rp2", maxTsCount=-1;

    config:
      core: |-
        # 静态文件域名
        staticResource:
          domain: "http://static.cloudcare.cn:10561"

  # 4.21 迭代
  - seq: 8
    database: |-
      -- 新增 db rp时长
      ALTER TABLE `main_workspace` ADD COLUMN `rpName` varchar(48) NOT NULL DEFAULT '' COMMENT 'db rp' AFTER `status`;

      -- 更新寄存rp db数据
      update main_workspace ws, main_influx_db db set ws.rpName = db.`influxRpName`  where ws.`dbUUID` = db.`uuid` and ws.`rpName` = "";

      -- 刷新 versionInfo字段数据 pass版对应 unlimited
      UPDATE main_workspace set versionInfo='{"rp": "rp5", "name": "无限版", "version": "unlimited", "ruleCount": -1, "maxTsCount": -1, "ruleActivePeriod": -1}';

      -- 节点新增 指标集字段
      ALTER TABLE `biz_node` ADD COLUMN `subTagKeyMeasurements` json NULL COMMENT '衍生节点标签指标集' AFTER `isInheritance`;
      -- 设置默认值
      UPDATE `biz_node` set subTagKeyMeasurements='[]';



  # 4.30 迭代
  - seq: 9
    database: |-
      -- 新增 是否开启数仓字段
      ALTER TABLE `main_workspace` ADD COLUMN `isOpenWarehouse` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否开启数据仓库' AFTER `dbUUID`;

      -- 新增 集成 fileName 用于排序
      ALTER TABLE `biz_integration` ADD COLUMN `fileName` varchar(128)  DEFAULT "" COMMENT '文件名 用于排序' AFTER `name`;

      -- 更新 main_ck_blacklist
      drop table main_ck_blacklist;

      -- 创建CK同步表
      CREATE TABLE `main_ck_datasync` (
        `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '自增 ID',
        `uuid` varchar(48) NOT NULL DEFAULT '' COMMENT '全局唯一 ID 前缀 ckds-',
        `dbUUID` varchar(48) NOT NULL DEFAULT '' COMMENT '原始 Measurement 所在 DB uuid',
        `measurement` varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '指标名',
        `tableName` varchar(128) NOT NULL DEFAULT '' COMMENT 'ck table name',
        `startTime` int(11) NOT NULL COMMENT '单位: 秒',
        `status` int(11) NOT NULL DEFAULT '0',
        `creator` varchar(64) NOT NULL DEFAULT '' COMMENT '创建者 account-id',
        `updator` varchar(64) NOT NULL DEFAULT '' COMMENT '更新者 account-id',
        `createAt` int(11) NOT NULL DEFAULT '-1',
        `deleteAt` int(11) NOT NULL DEFAULT '-1',
        `updateAt` int(11) NOT NULL DEFAULT '-1',
        PRIMARY KEY (`id`),
        UNIQUE KEY `uk_uuid` (`uuid`) COMMENT 'UUID 做成全局唯一'
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

      -- 更新 main_influx_cq
      drop table main_influx_cq;

      -- 重建 CQ表, 原表无数据
      CREATE TABLE `main_influx_cq` (
        `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '自增 ID',
        `uuid` varchar(48) NOT NULL DEFAULT '' COMMENT '全局唯一 ID 前缀 ifcq-',
        `dbUUID` varchar(48) NOT NULL DEFAULT '',
        `workspaceUUID` varchar(48) NOT NULL DEFAULT '' COMMENT '工作空间UUID',
        `sampleEvery` varchar(48) NOT NULL DEFAULT '30m' COMMENT 'RESAMPLE every XXX',
        `sampleFor` varchar(48) NOT NULL DEFAULT '1h' COMMENT 'RESAMPLE for XXX',
        `measurement` varchar(256) NOT NULL DEFAULT '' COMMENT '指标名',
        `rp` varchar(48) NOT NULL DEFAULT '' COMMENT '不填则只用 @db 的默认 RP',
        `cqrp` varchar(48) NOT NULL DEFAULT '' COMMENT '不填则用 CQ 默认的 RP, 比如 rpcq',
        `aggrFunc` varchar(48) NOT NULL DEFAULT 'mean',
        `groupByTime` varchar(48) NOT NULL DEFAULT '30m',
        `groupByOffset` varchar(48) NOT NULL DEFAULT '15m',
        `status` int(11) NOT NULL DEFAULT '0',
        `creator` varchar(64) NOT NULL DEFAULT '' COMMENT '创建者 account-id',
        `updator` varchar(64) NOT NULL DEFAULT '' COMMENT '更新者 account-id',
        `createAt` int(11) NOT NULL DEFAULT '-1',
        `deleteAt` int(11) NOT NULL DEFAULT '-1',
        `updateAt` int(11) NOT NULL DEFAULT '-1',
        PRIMARY KEY (`id`),
        UNIQUE KEY `uk_uuid` (`uuid`) COMMENT 'UUID 做成全局唯一'
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


  # 5.21 迭代
  - seq: 10
    database: |-
      -- 新增 清除数据时间
      ALTER TABLE `main_workspace_license` ADD COLUMN  `disableTime`  int(11) NULL DEFAULT 0 COMMENT '数据失效时间' AFTER `expire`;


  # 6.09 迭代
  - seq: 11
    config:
      core: |-
        # 此处配置的是 FT-CORE 默认的系统工作空间配置
        sysDatawaySet:
          defaultCfg:
            token: 此处是系统工作空间的token
            timeout: 3

        # ElasticsearchServer 服务器配置
        ElasticsearchServer:
          protocol: http
          host: ft-elasticsearch.middleware.svc.cluster.local
          port: 9200
          user: username
          password: xxxxxxxxxxx
          timeout: 30

    database: |-
      -- 新增 es 生命周期管理
      ALTER TABLE `main_workspace` ADD COLUMN  `esRP`  json NULL COMMENT 'es 生命周期管理' AFTER `autoAggregation`;

      -- 新增 日志提取表
      CREATE TABLE `main_log_extract_rule` (
        `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '自增 ID',
        `uuid` varchar(48) NOT NULL DEFAULT '' COMMENT '全局唯一 ID 前缀 taly-',
        `batchesID` varchar(48) NOT NULL COMMENT 'func批处理id',
        `workspaceUUID` varchar(48) NOT NULL DEFAULT '' COMMENT '工作空间 uuid',
        `source` varchar(48) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '来源',
        `funcId` varchar(48) NOT NULL DEFAULT '' COMMENT '解析方法',
        `url` varchar(128) NOT NULL DEFAULT '' COMMENT 'url',
        `funcKwargsJSON` json NOT NULL COMMENT 'func函数所需参数',
        `status` int(11) NOT NULL DEFAULT '0',
        `creator` varchar(64) NOT NULL DEFAULT '' COMMENT '创建者 account-id',
        `updator` varchar(64) NOT NULL DEFAULT '' COMMENT '更新者 account-id',
        `createAt` int(11) NOT NULL DEFAULT '-1',
        `deleteAt` int(11) NOT NULL DEFAULT '-1',
        `updateAt` int(11) NOT NULL DEFAULT '-1',
        PRIMARY KEY (`id`),
        UNIQUE KEY `uk_batchesID` (`batchesID`) COMMENT 'batchesID  做成全局唯一'
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


  # 6.30 迭代
  - seq: 12
    config:
      core: |-
        # kodo 配置中的 upgradeCmd配置项中，减少 `DW_VERSION={version}`项
        kodo:
          upgradeCmd: 'DW_KODO=https://kodo.dataflux.cn  DW_TOKEN={token}  DW_UUID={agent_uuid} DW_AK={ak}  DW_SK={sk} DW_UPGRADE=1  bash -c "$(curl https://static.dataflux.cn/dataway/install.sh)"'

    database: |-
      -- 新增apm配置表
      CREATE TABLE `main_apm_config` (
        `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '自增 ID',
        `uuid` varchar(48) NOT NULL DEFAULT '' COMMENT '全局唯一 ID 前缀 apmc-',
        `workspaceUUID` varchar(48) NOT NULL DEFAULT '' COMMENT '工作空间 uuid',
        `service` varchar(48) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '服务名',
        `config` json NOT NULL COMMENT 'apm配置参数',
        `status` int(11) NOT NULL DEFAULT '0',
        `creator` varchar(64) NOT NULL DEFAULT '' COMMENT '创建者 account-id',
        `updator` varchar(64) NOT NULL DEFAULT '' COMMENT '更新者 account-id',
        `createAt` int(11) NOT NULL DEFAULT '-1',
        `deleteAt` int(11) NOT NULL DEFAULT '-1',
        `updateAt` int(11) NOT NULL DEFAULT '-1',
        PRIMARY KEY (`id`),
        KEY `k_ws_uuid` (`workspaceUUID`),
        UNIQUE KEY `uk_uuid` (`uuid`) COMMENT 'UUID 做成全局唯一'
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

      -- 删除 main_agent 表的 workspace_uuid 索引, 并添加url字段
      ALTER TABLE `main_agent`
      ADD COLUMN `url` varchar(512) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '完整地址' AFTER `version`;


  # 7.16 迭代
  - seq: 13
    config:
      core: |-
        # 默认系统工作空间设置
        SystemWorkspaceSet:
          uuid: wksp_system

    database: |-
      -- 为规则类型`type`新增一个类型值`aggs`
      ALTER TABLE `biz_rule`
      MODIFY COLUMN `type` enum('trigger','baseline','aggs') CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL DEFAULT 'trigger' AFTER `workspaceUUID`;

      -- 为视图添加额外拓展字段
      ALTER TABLE `biz_dashboard` ADD COLUMN `extend` json NULL COMMENT '额外拓展字段' AFTER `type`;
      -- 刷视图数据
      UPDATE biz_dashboard set extend='{}' WHERE `status`=0

  # 8.4 迭代
  - seq: 14
    config:
      core: |-
        # 工单系统配置
        TicketServer:
          use_https: true
          port: 443
          host: "ticket-api.cloudcare.cn"
          ak_id: "dataflux-core" # 本系统在工单系统中的名字
          ak_secret: "xxxxxx"   # 本系统在工单系统中对应的安全密匙
          timeout: 30

  # 8.20 迭代
  - seq: 15
    database: |-
      -- 场景新增好图标字段, 并默认初始化为 空字典
      ALTER TABLE `biz_scene` ADD COLUMN `iconSet` json COMMENT '图标设置' AFTER `workspaceUUID`;
      UPDATE biz_scene SET iconSet='{}';