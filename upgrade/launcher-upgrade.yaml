upgradeInfo:
  - seq: 1
    config: |-
      当前版本的升级功能，需要 Elasticsearch 的支持，继续下一步之前，请先准备好 Elasticsearch 实例，并在右上角的 **Elasticsearch** 菜单中，按以下模板，增加 Elasticsearch 的实例配置信息：

      ```yaml
      ssl:  True
      host: 192.168.0.1
      port: 9200
      user: elastic
      password: 123456
      ```

      在升级完成，并全部服务启动之后，进入 launcher 容器，执行以下命令，初始化所有工作空间的 ES RP 信息：

      ```shell
      curl http://inner.forethought-core:5000/api/v1/inner/es/init -H "Content-Type:application/json" -X POST
      ```

  - seq: 2
    config: |-
      升级完成后，执行以下命令刷 ES 索引，禁用日期格式字符串自动转换成日期类型，执行前替换 Elasticsearch host、user、password：

      ```shell
      curl -XPOST "http://es-cn-stxxxx.elasticsearch.aliyuncs.com:9200/wksp_*/_mapping" -u user:password -H 'Content-Type: application/json' -d'{ "date_detection": false }'
      ```

      在升级完成，并全部服务启动之后，进入 launcher 容器，执行以下命令，重新初始化 ES 模板：

      ```shell
      curl http://inner.forethought-core:5000/api/v1/inner/es/init -H "Content-Type:application/json" -X POST
      ```

  - seq: 3
    config: |-
      升级前，在右上角的配置 -> 其他 -> tls 节点下面增加：tlsDisabled: false（表示是否禁用 TLS，如不启用 TLS，则值为 true），是否启用 TLS 的配置项，默认启用可以不添加此配置项。
      ```
        tls:
          tlsDisabled: false
      ```

      升级完成后，进入集群 launcher 容器，依次执行以下两条终端命令：

      执行以下命令，更新概览图指标卡标题：

      ```shell
      curl -H "Content-Type:application/json" -X POST 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data?script_name=fix_singlestat_chart_name'
      ```

      执行以下命令，更新 ES 索引模板：

      ```shell
      curl -H "Content-Type:application/json" -X POST 'http://inner.forethought-core:5000/api/v1/inner/es/init'
      ```

  - seq: 4
    config: |-
      * 此版本包含 Func 平台的重大升级，需要迁移数据库，**所以必须先备份好 MySQL 的所有数据库 (df_func、df_core、df_message_desk)**
      * 升级到此版本前，必须先升级到此版本的前一个版本： **1.9.48**（镜像地址：pubrepo.jiagouyun.com/dataflux/1.9.48:launcher-67a8ef4-1600314708），不可从更早的版本升级到此版本
      * 升级前，在右上角的配置 **MySQL** 配置 中，将 **func** 节点名称改为 **dataflux-func**
      * 升级前，先进行 Func 平台数据库的手工数据迁移，进入 Launcher 容器，执行以下命令：

          1. 进入 launcher/resource/v1/ddl/ 目录：

              ```
              cd /config/cloudcare-forethought-setup/launcher/resource/v1/ddl/
              ```

          2. 执行以下命令，迁移 Func 平台的数据库，注意替换命令中的参数，参数为 MySQL 数据库信息，使用 MySQL 的管理员账号密码，Database 为 Func 平台的数据库名称，一般是 df_func：
            
              ```
              python migrate_1_x.py --host <Host> --port <Port> --user <User> --password <Password> --database <Database>
              ```

  - seq: 5
    database:
      dataflux-func: |-
        -- 【日志及事件检测】字段批量替换，移除 __tags
        UPDATE biz_main_crontab_config 
          SET funcCallKwargsJSON = REPLACE(REPLACE(funcCallKwargsJSON, ".keyword", ""), "__tags.", "") 
        WHERE
          (funcId = 'dataflux__check_basic.keyevent_check_v2' or funcId = 'dataflux__check_basic.log_check') AND origin = 'API';


        -- 【日志检查】字段批量切换
        UPDATE biz_main_crontab_config 
          SET funcCallKwargsJSON = REPLACE(REPLACE(REPLACE(REPLACE(funcCallKwargsJSON, "__status", "status"), "__content", "message"), "__title", "title"), "__timestampMs", "date")
        WHERE
          funcId = 'dataflux__check_basic.log_check'
          AND origin = 'API';


        -- 【日志生成指标】字段批量切换
        UPDATE biz_main_crontab_config 
          SET funcCallKwargsJSON=REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(funcCallKwargsJSON, "__status", "status"), "__source", "source"), "__serviceName", "service"), "__parentID", "parent_id"), "__operationName", "operation"), "__spanID", "span_id"), "__traceID", "trace_id"), "__spanType", "span_type"), "__endpoint", "endpoint"), "__content", "message"), "__duration", "duration"), "__isError", "status"), "__name", "name"), "__class", "class"), "__timestampMs", "date")
        WHERE
          funcId = 'dataflux__collect.log_to_metric_generate'
          AND origin = 'API'

    config: |-
      * 注意：此版本升级，将调整 ES 数据的结构，**需要清理所有的 ES 数据**，包括 日志、事件、链路、RUM 等数据。
      * 版本升级完成后，进入 launcher 容器依次执行以下三个接口：

        1. 重新初始化 ES 模板

          ```
          curl 'http://inner.forethought-core:5000/api/v1/inner/es/init' -X 'POST'  -H 'Content-Type: application/json'
          ```

        2. 清理历史 ES 数据

          ```
          curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' \
          -H 'Content-Type: application/json' \
          --data-binary '{"script_name": "fix_clear_saas_free_workspace_es_indexs","scriptKwargs": {"clearAll": true}}' \
          --compressed
          ```

        3. 修复视图绑定关系数据

          ```
          curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json'  --data-binary '{"script_name": "fix_inner_dashboard_bind_relation","scriptKwargs": {}}'  --compressed
          ```

        4. 合并图表的 Queries 字段

          ```
          curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json'  --data-binary '{"script_name": "fix_2020_12_10","scriptKwargs": {}}'  --compressed
          ```

  - seq: 6
    database:
      dataflux-func: |-
        DELETE FROM biz_main_batch WHERE origin = 'API';
        TRUNCATE biz_main_batch_task_info;
        DELETE FROM biz_main_crontab_config WHERE origin = 'API';
        TRUNCATE biz_main_crontab_task_info;
    config: |-
      * 升级完成并全部启动成功后，进入 launcher 容器以下接口：

        1. 重新初始化 ES 模板

          ```
          curl 'http://inner.forethought-core:5000/api/v1/inner/es/init' -X 'POST'  -H 'Content-Type: application/json'
          ```


  # 2021-03-25
  - seq: 7
    config: |-
      * 升级完成并全部启动成功后，进入 launcher 容器执行以下接口：

        1. 重新初始化 ES 模板

          ```
          curl 'http://inner.forethought-core:5000/api/v1/inner/es/init' -X 'POST'  -H 'Content-Type: application/json' --compressed
          ```

        2. 清理对象索引

          ```
          curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -X 'POST'  -H 'Content-Type: application/json' --data-raw '{"script_name": "fix_clear_object_es_indexs"}' --compressed
          ```


  # 2021-04-07
  - seq: 8
    config: |-
      * 升级完成并全部启动成功后，进入 launcher 容器执行以下接口：

        1. 更新异常检查器

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json' --data-raw '{"script_name": "fix_update_checkers"}' --compressed
        ```


  # 2021-04-15
  - seq: 9
    config: |-
      * 升级完成并全部启动成功后，进入 launcher 容器执行以下接口：

        1. 刷新所有 ES 模版, 新增了 2个月的数据保留时长

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/es/init' -X 'POST'  -H 'Content-Type: application/json'
        ```


  # 2021-05-10
  - seq: 10
    config: |-
      **升级完成并全部启动成功后，进入 launcher 容器执行以下接口：**

      1、 执行 es_init 操作 刷新所有模版, 本次新增了 backup_log 和 security 类型数据索引

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/es/init' -X 'POST'  -H 'Content-Type: application/json'
        ```

      2、 清理现有工作空间中的 云关联开关

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json' --data-raw '{"script_name": "fix_clear_cloud_correlation_switch"}'
        ```

      3、 手工立即同步一次集成包

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json' --data-raw '{"script_name": "fix_update_integration"}'
        ```


  # 2021-05-20
  - seq: 11
    config: |-
      **升级完成并全部启动成功后，进入 launcher 容器执行以下接口：**

      1、 更新拨测任务地域：

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json' --data-raw '{"script_name": "fix_dialing_regions"}'
        ```

      2、 手工导入 geo 数据到数据库，在 launcher 容器执行以下脚本导入数据到 MySQL:

        * 连接到数据库实例

          ```
          mysql -h <host> -P <port> -u <user> -p<password>
          ```

        * 切换到 df_core 数据库

          ```
          use df_core;
          ```

        * 执行 geo 数据导入

          ```
          source /config/cloudcare-forethought-setup/launcher/resource/v1/ddl/geo.sql
          ```


