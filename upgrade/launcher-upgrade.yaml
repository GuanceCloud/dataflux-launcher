upgradeInfo:
  - seq: 1
    config: |-
      当前版本的升级功能，需要 Elasticsearch 的支持，继续下一步之前，请先准备好 Elasticsearch 实例，并在右上角的 **Elasticsearch** 菜单中，按以下模板，增加 Elasticsearch 的实例配置信息：

      ```yaml
      ssl:  True
      host: 192.168.0.1
      port: 9200
      user: elastic
      password: 123456
      ```

      在升级完成，并全部服务启动之后，进入 launcher 容器，执行以下命令，初始化所有工作空间的 ES RP 信息：

      ```shell
      curl http://inner.forethought-core:5000/api/v1/inner/es/init -H "Content-Type:application/json" -X POST
      ```

  - seq: 2
    config: |-
      升级完成后，执行以下命令刷 ES 索引，禁用日期格式字符串自动转换成日期类型，执行前替换 Elasticsearch host、user、password：

      ```shell
      curl -XPOST "http://es-cn-stxxxx.elasticsearch.aliyuncs.com:9200/wksp_*/_mapping" -u user:password -H 'Content-Type: application/json' -d'{ "date_detection": false }'
      ```

      在升级完成，并全部服务启动之后，进入 launcher 容器，执行以下命令，重新初始化 ES 模板：

      ```shell
      curl http://inner.forethought-core:5000/api/v1/inner/es/init -H "Content-Type:application/json" -X POST
      ```

  - seq: 3
    config: |-
      升级前，在右上角的配置 -> 其他 -> tls 节点下面增加：tlsDisabled: false（表示是否禁用 TLS，如不启用 TLS，则值为 true），是否启用 TLS 的配置项，默认启用可以不添加此配置项。
      ```
        tls:
          tlsDisabled: false
      ```

      升级完成后，进入集群 launcher 容器，依次执行以下两条终端命令：

      执行以下命令，更新概览图指标卡标题：

      ```shell
      curl -H "Content-Type:application/json" -X POST 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data?script_name=fix_singlestat_chart_name'
      ```

      执行以下命令，更新 ES 索引模板：

      ```shell
      curl -H "Content-Type:application/json" -X POST 'http://inner.forethought-core:5000/api/v1/inner/es/init'
      ```

  - seq: 4
    config: |-
      * 此版本包含 Func 平台的重大升级，需要迁移数据库，**所以必须先备份好 MySQL 的所有数据库 (df_func、df_core、df_message_desk)**
      * 升级到此版本前，必须先升级到此版本的前一个版本： **1.9.48**（镜像地址：pubrepo.jiagouyun.com/dataflux/1.9.48:launcher-67a8ef4-1600314708），不可从更早的版本升级到此版本
      * 升级前，在右上角的配置 **MySQL** 配置 中，将 **func** 节点名称改为 **dataflux-func**
      * 升级前，先进行 Func 平台数据库的手工数据迁移，进入 Launcher 容器，执行以下命令：

          1. 进入 launcher/resource/v1/ddl/ 目录：

              ```
              cd /config/cloudcare-forethought-setup/launcher/resource/v1/ddl/
              ```

          2. 执行以下命令，迁移 Func 平台的数据库，注意替换命令中的参数，参数为 MySQL 数据库信息，使用 MySQL 的管理员账号密码，Database 为 Func 平台的数据库名称，一般是 df_func：
            
              ```
              python migrate_1_x.py --host <Host> --port <Port> --user <User> --password <Password> --database <Database>
              ```

  - seq: 5
    database:
      dataflux-func: |-
        -- 【日志及事件检测】字段批量替换，移除 __tags
        UPDATE biz_main_crontab_config 
          SET funcCallKwargsJSON = REPLACE(REPLACE(funcCallKwargsJSON, ".keyword", ""), "__tags.", "") 
        WHERE
          (funcId = 'dataflux__check_basic.keyevent_check_v2' or funcId = 'dataflux__check_basic.log_check') AND origin = 'API';


        -- 【日志检查】字段批量切换
        UPDATE biz_main_crontab_config 
          SET funcCallKwargsJSON = REPLACE(REPLACE(REPLACE(REPLACE(funcCallKwargsJSON, "__status", "status"), "__content", "message"), "__title", "title"), "__timestampMs", "date")
        WHERE
          funcId = 'dataflux__check_basic.log_check'
          AND origin = 'API';


        -- 【日志生成指标】字段批量切换
        UPDATE biz_main_crontab_config 
          SET funcCallKwargsJSON=REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(funcCallKwargsJSON, "__status", "status"), "__source", "source"), "__serviceName", "service"), "__parentID", "parent_id"), "__operationName", "operation"), "__spanID", "span_id"), "__traceID", "trace_id"), "__spanType", "span_type"), "__endpoint", "endpoint"), "__content", "message"), "__duration", "duration"), "__isError", "status"), "__name", "name"), "__class", "class"), "__timestampMs", "date")
        WHERE
          funcId = 'dataflux__collect.log_to_metric_generate'
          AND origin = 'API'

    config: |-
      * 注意：此版本升级，将调整 ES 数据的结构，**需要清理所有的 ES 数据**，包括 日志、事件、链路、RUM 等数据。
      * 版本升级完成后，进入 launcher 容器依次执行以下三个接口：

        1. 重新初始化 ES 模板

          ```
          curl 'http://inner.forethought-core:5000/api/v1/inner/es/init' -X 'POST'  -H 'Content-Type: application/json'
          ```

        2. 清理历史 ES 数据

          ```
          curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' \
          -H 'Content-Type: application/json' \
          --data-binary '{"script_name": "fix_clear_saas_free_workspace_es_indexs","scriptKwargs": {"clearAll": true}}' \
          --compressed
          ```

        3. 修复视图绑定关系数据

          ```
          curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json'  --data-binary '{"script_name": "fix_inner_dashboard_bind_relation","scriptKwargs": {}}'  --compressed
          ```

        4. 合并图表的 Queries 字段

          ```
          curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json'  --data-binary '{"script_name": "fix_2020_12_10","scriptKwargs": {}}'  --compressed
          ```

  - seq: 6
    database:
      dataflux-func: |-
        DELETE FROM biz_main_batch WHERE origin = 'API';
        TRUNCATE biz_main_batch_task_info;
        DELETE FROM biz_main_crontab_config WHERE origin = 'API';
        TRUNCATE biz_main_crontab_task_info;
    config: |-
      * 升级完成并全部启动成功后，进入 launcher 容器以下接口：

        1. 重新初始化 ES 模板

          ```
          curl 'http://inner.forethought-core:5000/api/v1/inner/es/init' -X 'POST'  -H 'Content-Type: application/json'
          ```


  # 2021-03-25
  - seq: 7
    config: |-
      * 升级完成并全部启动成功后，进入 launcher 容器执行以下接口：

        1. 重新初始化 ES 模板

          ```
          curl 'http://inner.forethought-core:5000/api/v1/inner/es/init' -X 'POST'  -H 'Content-Type: application/json' --compressed
          ```

        2. 清理对象索引

          ```
          curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -X 'POST'  -H 'Content-Type: application/json' --data-raw '{"script_name": "fix_clear_object_es_indexs"}' --compressed
          ```


  # 2021-04-07
  - seq: 8
    config: |-
      * 升级完成并全部启动成功后，进入 launcher 容器执行以下接口：

        1. 更新异常检查器

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json' --data-raw '{"script_name": "fix_update_checkers"}' --compressed
        ```


  # 2021-04-15
  - seq: 9
    config: |-
      * 升级完成并全部启动成功后，进入 launcher 容器执行以下接口：

        1. 刷新所有 ES 模版, 新增了 2个月的数据保留时长

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/es/init' -X 'POST'  -H 'Content-Type: application/json'
        ```


  # 2021-05-10
  - seq: 10
    config: |-
      **升级完成并全部启动成功后，进入 launcher 容器执行以下接口：**

      1、 执行 es_init 操作 刷新所有模版, 本次新增了 backup_log 和 security 类型数据索引

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/es/init' -X 'POST'  -H 'Content-Type: application/json'
        ```

      2、 清理现有工作空间中的 云关联开关

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json' --data-raw '{"script_name": "fix_clear_cloud_correlation_switch"}'
        ```

      3、 手工立即同步一次集成包

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json' --data-raw '{"script_name": "fix_update_integration"}'
        ```


  # 2021-05-20
  - seq: 11
    config: |-
      **升级完成并全部启动成功后，进入 launcher 容器执行以下接口：**

      1、 更新拨测任务地域：

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json' --data-raw '{"script_name": "fix_dialing_regions"}'
        ```

      2、 手工导入 geo 数据到数据库，在 launcher 容器执行以下脚本导入数据到 MySQL:

        * 连接到数据库实例

          ```
          mysql -h <host> -P <port> -u <user> -p<password>
          ```

        * 切换到 df_core 数据库

          ```
          use df_core;
          ```

        * 执行 geo 数据导入

          ```
          source /config/cloudcare-forethought-setup/launcher/resource/v1/ddl/geo.sql
          ```

  # 2021-06-07
  - seq: 12
    config: |-
      **升级完成并全部启动成功后，进入 launcher 容器执行以下接口：**

      1、更新现有聚合规则：

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json' --data-raw '{"script_name": "fix_update_aggs_to_metric"}'
        ```

      2、版本更新现有用户的登录次数：

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json' --data-raw '{"script_name": "fix_init_loginnum"}'
        ```

      3、更新现有【免费版/付费版】工作空间的RP设置：

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json' --data-raw '{"script_name": "fix_rp_2021_06_03"}'
        ```

  # 2021-07-01
  - seq: 13
    config: |-
      **升级完成并全部启动成功后，进入 launcher 容器执行以下接口：**

      1、刷新 Elasticsearch 中的事件模板：

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/es/init' -X 'POST'  -H 'Content-Type: application/json'
        ```

      2、事件的数据字段变更，将旧数据迁移并转换为新结构，并删除老数据索引：

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json' --data-raw '{"script_name": "fix_reindex"}'
        ```

  # 2021-08-12
  - seq: 14
    config: |-
      **升级完成并全部启动成功后，进入 launcher 容器执行以下接口：**

      1、更新所有账号的角色：

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json' --data-raw '{"script_name": "fix_update_account_role"}'
        ```

  # 2021-08-26
  - seq: 15
    config: |-
      **升级完成并全部启动成功后，进入 launcher 容器执行以下接口：**

      1、修复日志备份规则的参数问题

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json' --data-raw '{"script_name": "fix_update_logbackup_rule"}'
        ```

      2、更新 ES 索引模板，链路的 message 不做全文索引

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/es/init' -X 'POST'  -H 'Content-Type: application/json'
        ```

  # 2021-09-09
  - seq: 16
    config: |-
      **升级完成并全部启动成功后，进入 launcher 容器执行以下接口：**

      1、刷新事件索引模版

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json' --data-raw '{"script_name": "fix_keyevent_index_template_2021_09_09"}'
        ```

  # 2021-09-28
  - seq: 17
    config: |-
      **升级完成并全部启动成功后，进入 launcher 容器执行以下接口：**

      1、刷新 ES 索引模版

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/es/init' -X 'POST'  -H 'Content-Type: application/json'
        ```

  # 2021-11-04
  - seq: 18
    config: |-
      **升级完成并全部启动成功后，进入 launcher 容器执行以下接口：**

      1、场景改为“仪表板”，更新视图名字

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json' --data-raw $'{"script_name": "fix_20211104_update_dashboard"}'
        ```

  # 2021-11-18
  - seq: 19
    config: |-
      **升级完成并全部启动成功后，进入 launcher 容器执行以下接口：**

      1、异常检测项的恢复周期问题修复

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json' --data-raw '{"script_name": "fix_update_checkers"}'
        ```

      2、场景名称迁移到 tag 

        ```
        curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json' --data-raw '{"script_name": "fix_2021_11_18_update_tag"}'
        ```

  # 2021-12-02
  - seq: 20
    config: |-
      **升级完成并全部启动成功后，进入 launcher 容器执行以下接口：**
      ```
      curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json' --data-raw '{"script_name": "fix_update_owner_workspace_account"}'
      ```

  # 2022-01-20
  - seq: 22
    func_exec: script_1230
    config: |-
      **升级前，请先检查 Elasticsearch 的配置信息是否正确的（此版本开始， Elasticsearch 的实例信息安装程序会自动写入到 MySQL 表中）：**
        
      **1. 在 Launcher 右上角的“设置”中，打开 Elasticsearch 的配置，补充完整以下一项配置：**

      ```
      provider: elastic 
      ```

      **provider** 的可选值有 `elastic、opensearch、aliyun、aws` 四个选项，根据实际使用的 Elasticsearch 产品选择以下值，分别表示：

      * elastic: elastic 官方原版 Elasticsearch
      * opensearch: elasticsearch 的开源版
      * aliyun: Aliyun 上的 Elasticsearch 云产品
      * aws: AWS 上的 OpenSearch 云产品

      **2. 本次更新增加 Open API 服务，需要在 “域名” 配置信息的中 “subDomain” 下增加一个二级域名配置（openApi 二级域名以实际需要的配置，可以自行起任意二级域名名字）**

      ```
      subDomain:
        openApi: openapi
      ```

      **升级完成后，执行以下两个脚本：**

      **1. 进入 Launcher 容器，执行以下接口：**

      ```
      curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json' --data-raw '{"script_name": "fix_2022_01_20_create_default_monitor"}'
      ```

      **2. 进入 forethought-core namespace 下的 front-backend 容器，执行以下 Python 命令：**
      ```
      python -c "from forethought.tasks.sync_inner_metric_config import update_inner_metric_config; update_inner_metric_config();"
      ```

  # 2022-02-22
  - seq: 23
    config: |-
      **升级完成并全部启动成功后，进入 launcher 容器执行以下接口：**

      1、清理 SLO 删除之后未清理的 SLO 组合配置

      ``` 
      curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/fix_data' -H 'Content-Type: application/json' --data-raw $'{"script_name": "fix_2022_02_22_clear_deleted_slo_rule"}'
      ```

      2、同步官方内置 Pipeline 库，如服务器不能访问公网，需要手工导入

      ```
      curl 'http://inner.forethought-core:5000/api/v1/inner/upgrade/tasks/execute_task_func' -H 'Content-Type: application/json' --data-raw '{"script_name": "timed_sync_pipeline_template", "func_name": "timed_sync_pull", "funcKwargs": {"need_sync_pipline": true}}'
      ```

  # 2022-04-18 迭代
  - seq: 24
    func_exec: script_20220418

  # 2022-06-06 迭代
  - seq: 25
    func_exec: script_20220606

  # 2022-06-22 迭代
  - seq: 26
    config: |-
      **本次更新需要做一些升级前的操作：**

      * 本次更新增加 帮助中心 服务，需要在 “域名” 配置信息的中 “subDomain” 下增加一个二级域名配置（docs 二级域名以实际需要的配置，可以自行起任意二级域名名字）

      ```
      subDomain:
        docs: df-docs
      ```

  # 2022-09-29 fix 版本
  - seq: 28
    func_exec: script_20220929

  # 2022-10-12 迭代的 fix 版本
  - seq: 29
    func_exec: script_20221012

  # 2022-10-20 迭代的 fix 版本
  - seq: 30
    func_exec: script_20221020

  # 2022-11-17 迭代的 fix 版本
  - seq: 31
    func_exec: script_20221117

  # 2022-12-01 迭代的版本
  - seq: 32
    func_exec: script_20221201

  # 2022-12-29 迭代的版本
  - seq: 33
    func_exec: script_20221229

  # 2023-1-12 迭代的版本
  - seq: 34
    func_exec: script_20230112

  # 2023-2-23 迭代的版本
  - seq: 35
    func_exec: script_20230223

  # 2023-03-09 迭代的版本
  - seq: 36
    config: |-
      **如果是离线部署的用户升级到此版本，由于默认镜像仓库 host 名称的变更，需要执行以下步骤：**

      ```
      1. 将位于 launcher 命名空间中名为 registry-key 的 Secret 中的 registry domain name 修改为 pubrepo.guance.com。
      ```

  # 2023-3-23 迭代的版本
  - seq: 37
    func_exec: script_20230323


  # 2023-04-06 迭代的版本
  - seq: 38
    func_exec: script_20230406


  # 2023-04-20 迭代的版本
  - seq: 39
    func_exec: script_20230420


  # 2023-05-06 迭代的版本
  - seq: 40
    func_exec: script_20230506


  # 2023-05-22 迭代的版本
  - seq: 41
    func_exec: script_20230522
    config: |-
      > 此版本新增了私有拨测服务。在点击“下一步”之前，请仔细阅读以下信息，并按照以下步骤进行配置：

      * **步骤1**：在点击“下一步”之前，您需要为拨测服务指定一个二级域名。默认的二级域名为`dialtesting`，您可以根据自身需求选择合适的二级域名。在右上角的 "设置" -> “域名” -> "subDomain" 下添加配置：

      ```yaml
      subDomain:
        dialtesting: 您选择的二级域名
      ```

      * **步骤2**：如果您选择使用私有拨测服务，需要做以下配置：
          * 在点击“下一步”之前，在右上角的 "设置" -> “其他” 下添加配置： `dialService: buildin`。
          * 升级完成后，在右上角的 "设置" -> “修改应用配置” 中，修改 “forethought-core” -> "core" 的配置：

      ```yaml
      # 拨测服务的配置，需要修改为私有拨测服务的详细信息
      # host：拨测服务的 http 域名地址
      # use_https: 是否使用 https
      # port：拨测服务的 http 访问端口
      DialingServer:
        use_https: True
        host: 您选择的二级域名.xxx.com
        port: 443
      ```

      * **步骤3**：升级完成后，在右上角的 "设置" -> “License 激活及 AK/SK 配置” 下重新进行激活操作。